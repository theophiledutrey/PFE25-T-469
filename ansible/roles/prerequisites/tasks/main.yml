---
- name: Check OS compatibility
  block:
    - name: Verify OS is supported
      ansible.builtin.assert:
        that:
          - ansible_facts['distribution'] in ['Debian', 'Ubuntu', 'MacOSX'] or ansible_facts['os_family'] == 'Windows'
        fail_msg: "OS must be Debian, Ubuntu, MacOS, or Windows. Found: {{ ansible_facts['distribution'] }}"

    - name: Check for Supported versions (Strict)
      ansible.builtin.assert:
        that:
          - >-
            (ansible_facts['distribution'] == 'Debian' and ansible_facts['distribution_major_version'] == '12') or
            (ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_major_version'] in ['22', '24']) or
            (ansible_facts['distribution'] == 'Debian' and ansible_facts['distribution_major_version'] == '11') or
            (ansible_facts['distribution'] == 'MacOSX' and ansible_facts['distribution_major_version'] | int >= 12) or
            (ansible_facts['os_family'] == 'Windows')
        fail_msg: "OS version not supported. Found: {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_major_version'] }}"

    - name: Warn for Debian 11
      ansible.builtin.debug:
        msg: "[WARN] OS is Debian 11. Proceed with caution."
      when: ansible_facts['distribution'] == 'Debian' and ansible_facts['distribution_major_version'] == '11'

    - name: Confirm Supported OS
      ansible.builtin.debug:
        msg: "[OK] OS is {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_major_version'] }}"
      when: >
        (ansible_facts['distribution'] == 'Debian' and ansible_facts['distribution_major_version'] == '12') or
        (ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_major_version'] in ['22', '24']) or
        (ansible_facts['distribution'] == 'MacOSX' and ansible_facts['distribution_major_version'] | int >= 12) or
        (ansible_facts['os_family'] == 'Windows')

- name: Check RAM requirements
  block:
    - name: Check minimum RAM (1.8GB)
      ansible.builtin.assert:
        that:
          - ansible_facts['memtotal_mb'] >= 1800
        fail_msg: "Memory: {{ ansible_facts['memtotal_mb'] }}MB (< 1.8GB). Wazuh will not run."

    - name: Check recommended RAM (4GB)
      ansible.builtin.debug:
        msg: "[WARN] Memory: {{ ansible_facts['memtotal_mb'] }}MB (< 4GB). Wazuh might be slow."
      when: ansible_facts['memtotal_mb'] >= 1800 and ansible_facts['memtotal_mb'] < 4000

    - name: Confirm RAM
      ansible.builtin.debug:
        msg: "[OK] Memory: {{ ansible_facts['memtotal_mb'] }}MB (>= 4GB)"
      when: ansible_facts['memtotal_mb'] >= 4000

- name: Check Disk Space on /
  block:
    - name: Get Disk Space info (Linux)
      ansible.builtin.set_fact:
        root_disk: "{{ ansible_facts['mounts'] | selectattr('mount', 'equalto', '/') | list | first }}"
      when: ansible_facts['system'] == 'Linux'

    - name: Get Disk Space info (MacOS)
      ansible.builtin.shell: df -k / | tail -1 | awk '{print $4}'
      register: mac_df
      changed_when: false
      when: ansible_facts['distribution'] == 'MacOSX'

    - name: Set Disk Fact (MacOS)
      ansible.builtin.set_fact:
        root_disk:
          size_available: "{{ (mac_df.stdout | int) * 1024 }}"
      when: ansible_facts['distribution'] == 'MacOSX'

    - name: Get Disk Space info (Windows)
      ansible.builtin.set_fact:
        root_disk: "{{ ansible_facts['mounts'] | selectattr('mount', 'equalto', 'C:\\') | list | first | default(ansible_facts['mounts'][0]) }}"
      when: ansible_facts['os_family'] == 'Windows'

    - name: Display Free Disk Space
      ansible.builtin.debug:
        msg: "[INFO] Free Disk Space: {{ (root_disk.size_available | float / 1024 / 1024 / 1024) | round(2) }} GB"

- name: Check Root privileges
  block:
    - name: Verify running as root (Unix)
      ansible.builtin.debug:
        msg: "[WARN] Script not running as root. Ansible requires sudo/root."
      when: ansible_facts['os_family'] != 'Windows' and ansible_facts['user_uid'] != 0

    - name: Confirm Root (Unix)
      ansible.builtin.debug:
        msg: "[OK] Running as root"
      when: ansible_facts['os_family'] != 'Windows' and ansible_facts['user_uid'] == 0

    - name: Confirm Windows Admin
      ansible.builtin.debug:
        msg: "[INFO] Windows user permissions override."
      when: ansible_facts['os_family'] == 'Windows'
